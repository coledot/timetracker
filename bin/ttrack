#!/Users/alex/.rvm/rubies/ruby-1.9.2-p290/bin/ruby -w
require 'ttrack'

def usage(tt)
  puts 'Usage: ttrack [%s]' % (tt.commands * '|')
end

databasename = "%s/%s" % [ENV['HOME'], ".timetrackerdb"]
tt = TTrack.new databasename
case ARGV[0]
  when 'start' then
    stop = tt.start(ARGV[1], ARGV[2])
    if stop and not stop[1].nil?
      puts 'Stop tracking issue "%s", run for %s' % [
        stop[1][:name],
        Time.at(stop[1][:elapsed]).utc.strftime("%H hours %M minutes %S seconds")
      ]
      puts 'Start tracking issue "%s"' % ARGV[1]
    elsif stop
      puts 'Start tracking issue "%s"' % ARGV[1]
    else
      usage(tt)
    end

  when 'stop' then
    stop = tt.stop
    if stop
      puts 'Stop issue "%s", run for %s' % [
        stop[:name],
        Time.at(stop[:elapsed]).utc.strftime("%H hours %M minutes %S seconds")
      ]
    else
      puts('Not tracking')
    end

  when 'status' then
    status = tt.status(ARGV[1])
    unless status.nil?
      puts 'Stats for task "%s": %s' % [
        status[:task],
        Time.at(status[:elapsed]).utc.strftime("%H hours %M minutes %S seconds")
      ]
    else
      puts "Currently not tracking"
    end

  when 'init' then
    puts 'Initlializing empty sqlite database: %s' % databasename
    tt.init

  when 'report' then
    report = tt.report(ARGV[1])
    unless report.nil?
      report.each do |line|
        puts line
      end
    end

  when 'begin' then
    begin
      timestamp = ARGV[3] ? "%s %s" % ARGV[2..3] : ARGV[2]
      tt.set_tstart! ARGV[1], timestamp
    rescue Exception => e
      usage(tt)
    end

  when 'end' then
    begin
      timestamp = ARGV[3] ? "%s %s" % ARGV[2..3] : ARGV[2]
      tt.set_tstop! ARGV[1], timestamp
    rescue
      usage(tt)
    end

  else
    usage(tt)
end
